<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trignis - A fast change tracking service for SQL Server</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <base target="_blank">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        }
        .gradient-text {
            background: linear-gradient(90deg, #9333ea 0%, #9333ea 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .disable-select {
            -webkit-user-select: none;  
            -moz-user-select: none;    
            -ms-user-select: none;      
            user-select: none;
        }
        /* Animation for loading state */
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .pulse-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
        /* Enhanced hover effect for release badge */
        #github-release {
            transition: all 0.2s ease;
        }
        #github-release:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="bg-white text-gray-900 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl mx-auto space-y-12">
        <header class="text-center disable-select">
            <!-- Logo and title section -->
            <div class="mb-1">
                <div class="flex items-center justify-center">
                    <h1 class="text-5xl font-bold gradient-text pb-1">Trignis</h1>
                </div>
                
                <!-- GitHub release badge with additional info -->
                <div class="mt-3 mb-1 flex justify-center">
                    <div class="inline-flex items-center space-x-2">
                        <!-- Version badge -->
                        <a href="https://github.com/melosso/trignis/releases" id="github-release" class="group text-xs bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-full px-3 py-1 text-gray-500 font-medium inline-flex items-center transition-all duration-200">
                            <svg class="w-3.5 h-3.5 mr-1 text-gray-400 group-hover:text-gray-600 transition-colors" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            <span id="release-info" class="pulse-animation">Loading...</span>
                        </a>
                        
                        <!-- Stability badge -->
                        <a id="stability-badge" href="https://github.com/melosso/trignis/releases" class="text-xs bg-green-50 hover:bg-green-100 border border-green-200 rounded-full px-3 py-1 text-green-600 font-medium inline-flex items-center transition-all duration-200">
                            <svg class="w-3.5 h-3.5 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Stable</span>
                        </a>
                        
                        <!-- Issues badge -->
                        <a id="issues-badge" href="https://github.com/melosso/trignis/issues" class="text-xs bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-full px-3 py-1 text-gray-500 font-medium inline-flex items-center transition-all duration-200">
                            <svg class="w-3.5 h-3.5 mr-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span id="issues-count" class="pulse-animation">Loading...</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <p class="text-xl text-gray-600 max-w-2xl mx-auto mt-4">
                A fast change tracking service for SQL Server.
            </p>
        </header>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <h2 class="text-3xl font-semibold text-gray-800">Quick overview</h2>
                <p class="text-gray-700 text-lg">
                    Trignis is an open-source, community-driven fast change tracking service for SQL Server databases. It monitors database changes in real-time. Built for Windows, ready for Docker.
                </p>
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0 pt-2">
                    <a href="https://github.com/melosso/trignis?tab=readme-ov-file#trignis" class="w-full text-sm h-14 bg-gradient-to-r from-gray-200 to-gray-100 text-gray-800 px-6 rounded-lg hover:opacity-90 transition flex items-center justify-center" style="user-select: none;">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 20h9" />
                            <path d="M12 4h9" />
                            <path d="M4 9h16" />
                            <path d="M4 15h16" />
                        </svg>
                        Get Started!
                    </a>

                    <a href="https://github.com/melosso/trignis/blob/main/LICENSE" class="w-full text-sm h-14 bg-gradient-to-r from-purple-500 to-purple-400 text-white px-6 rounded-lg hover:opacity-90 transition flex items-center justify-center" style="user-select: none;">
                        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 5H3c-1.1 0-1.99.9-1.99 2L1 17c0 1.1.9 2 1.99 2h18c1.1 0 1.99-.9 1.99-2L23 7c0-1.1-.9-2-1.99-2zM3 17V7h18v10H3z"/>
                        </svg>
                        View License
                    </a>
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-3xl font-semibold text-gray-800">Get started</h2>
                <div class="flex flex-col space-y-4">
                    <a href="https://github.com/melosso/trignis/pkgs/container/trignis" target="_blank" class="w-full h-14 bg-white border border-gray-300 text-gray-800 px-6 rounded-lg hover:bg-gray-100 transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M15 10l4.553 2.276A1 1 0 0120 13.118V18a2 2 0 01-2 2H6a2 2 0 01-2-2v-4.882a1 1 0 01.447-.842L9 10m3-7v11" />
                        </svg>
                        Get Docker Image
                    </a>

                    <!-- Launch Preview button - wrapped so we can position an overlay badge in the top-right -->
                    <div class="relative w-full">
                        <a href="https://github.com/melosso/trignis" class="w-full h-14 bg-gradient-to-r from-purple-700 to-purple-500 text-white px-6 rounded-lg hover:opacity-90 transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
                        </svg>
                        View on GitHub
                    </a>

                        <!-- Overlay badge (top-right) shown when preview is 'offline' according to server GMT+1 time -->
                        <div id="preview-overlay" class="hidden absolute -top-2 -right-2 transform translate-x-1/2 translate-y-0">
                            <div class="text-white text-xs font-semibold px-3 py-1 rounded-full shadow-sm flex items-center space-x-2" style="background-color: rgba(218, 88, 88, 0.65);">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-1.414 1.414M6.343 17.657l-1.414 1.414M6.343 6.343l1.414 1.414M17.657 17.657l1.414 1.414" />
                                </svg>
                                <div class="text-left leading-tight">
                                    <div id="overlay-title" style="user-select: none;">Offline</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="https://github.com/melosso/trignis/releases" id="download-link" class="w-full h-14 bg-gray-800 text-white px-6 rounded-lg hover:opacity-90 transition flex items-center justify-center" style="user-select: none;">
                        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2a1 1 0 0 1 1 1v10.586l3.293-3.293a1 1 0 0 1 1.414 1.414l-5 5a1 1 0 0 1-1.414 0l-5-5a1 1 0 0 1 1.414-1.414L11 13.586V3a1 1 0 0 1 1-1zM4 18a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H5a1 1 0 0 1-1-1z"/>
                        </svg>
                        Download latest version
                    </a>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 disable-select">
            <p>
                Open Source • 
            <span 
                style="cursor: pointer;" 
                onclick="window.open('https://github.com/melosso/trignis/blob/main/LICENSE', '_blank')"
                >
                Licensed under AGPL (3.0)
            </span>
            </p>
        </footer>
    </div>

    <script>
        // Debug logging helper
        function logDebug(message, data) {
            console.log(`%c${message}`, 'background: #333; color: #bada55', data || '');
        }

        // Attempt to initialize the issues count from cache first
        function initializeFromCache() {
            logDebug('Initializing from cache if available');
            let issuesCached = false;
            let releasesCached = false;
            const currentTime = new Date().getTime();
            
            // First check for GitHub issues cache
            const cachedIssues = localStorage.getItem('github-issues-data');
            const cachedIssuesTime = localStorage.getItem('github-issues-time');
            
            if (cachedIssues && cachedIssuesTime && (currentTime - parseInt(cachedIssuesTime) < 12 * 60 * 60 * 1000)) {
                logDebug('Found valid issues cache, using it', new Date(parseInt(cachedIssuesTime)));
                try {
                    const data = JSON.parse(cachedIssues);
                    if (data && typeof data.total_count === 'number') {
                        const issuesElement = document.getElementById('issues-count');
                        const count = data.total_count;
                        issuesElement.textContent = `${count} ${count === 1 ? 'issue' : 'issues'}`;
                        issuesElement.classList.remove('pulse-animation');
                        logDebug('Successfully updated issues count from cache:', count);
                        issuesCached = true;
                    }
                } catch (error) {
                    logDebug('Error parsing cached issues data:', error);
                }
            } else {
                logDebug('No valid issues cache found or cache expired');
            }
            
            // Also initialize releases from cache
            const cachedData = localStorage.getItem('github-release-data');
            const cachedTime = localStorage.getItem('github-release-time');
            
            if (cachedData && cachedTime && (currentTime - parseInt(cachedTime) < 12 * 60 * 60 * 1000)) {
                logDebug('Found valid release cache, using it', new Date(parseInt(cachedTime)));
                try {
                    const data = JSON.parse(cachedData);
                    if (data && data.tag_name) {
                        // Update version number
                        const releaseElement = document.getElementById('release-info');
                        releaseElement.textContent = data.tag_name;
                        releaseElement.classList.remove('pulse-animation');
                        
                        // Update download link
                        const downloadLink = document.getElementById('download-link');
                        if (data.assets && data.assets.length > 0) {
                            downloadLink.href = data.assets[0].browser_download_url;
                        } else {
                            downloadLink.href = data.html_url;
                        }
                        
                        // Update release badge link
                        const releaseLink = document.getElementById('github-release');
                        releaseLink.href = data.html_url;
                        
                        // Show stability badge if not a pre-release
                        const stabilityBadge = document.getElementById('stability-badge');
                        if (!data.prerelease) {
                            stabilityBadge.classList.remove('hidden');
                            logDebug('Showing stability badge');
                        }
                        
                        logDebug('Successfully updated release info from cache:', data.tag_name);
                        releasesCached = true;
                    }
                } catch (error) {
                    logDebug('Error parsing cached release data:', error);
                }
            } else {
                logDebug('No valid release cache found or cache expired');
            }
            
            return { issuesCached, releasesCached };
        }
        
        // Function to fetch GitHub issues only if needed
        async function fetchGitHubData() {
            logDebug('Starting GitHub data fetch process');
            
            // Try to load from cache first
            const { issuesCached, releasesCached } = initializeFromCache();
            
            // If issues are already loaded from cache, we don't need to fetch them
            if (!issuesCached) {
                logDebug('Issues not found in cache, fetching from API');
                fetchGitHubIssues();
            }
            
            // Check if releases need to be fetched
            const cachedData = localStorage.getItem('github-release-data');
            const cachedTime = localStorage.getItem('github-release-time');
            const currentTime = new Date().getTime();
            
            if (!cachedData || !cachedTime || (currentTime - parseInt(cachedTime) >= 12 * 60 * 60 * 1000)) {
                logDebug('Release data not in cache or expired, fetching from API');
                fetchGitHubReleases();
            }
        }
        
        // Function to fetch GitHub release information
        async function fetchGitHubReleases() {
            logDebug('Fetching GitHub releases');
            const currentTime = new Date().getTime();
            
            try {
                const response = await fetch('https://api.github.com/repos/melosso/trignis/releases/latest');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                logDebug('Received release data:', data.tag_name);
                
                // Save to localStorage with current timestamp
                localStorage.setItem('github-release-data', JSON.stringify(data));
                localStorage.setItem('github-release-time', currentTime.toString());
                
                // Update UI with the fetched data
                updateReleaseInfo(data);
            } catch (error) {
                console.error('Error fetching GitHub release:', error);
                document.getElementById('release-info').textContent = 'Latest release';
                document.getElementById('release-info').classList.remove('pulse-animation');
            }
        }
        
        // Function to fetch GitHub issues
        async function fetchGitHubIssues() {
            logDebug('Fetching GitHub issues');
            const currentTime = new Date().getTime();

            try {
                // Direct API call for open issues count
                const issuesUrl = 'https://api.github.com/search/issues?q=repo:melosso/trignis+state:open+type:Bug';
                const response = await fetch(issuesUrl);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                logDebug('Received issues data:', data);
                
                if (data && typeof data.total_count === 'number') {
                    // Save to localStorage with current timestamp
                    localStorage.setItem('github-issues-data', JSON.stringify(data));
                    localStorage.setItem('github-issues-time', currentTime.toString());
                    logDebug('Saved issues data to cache with timestamp:', new Date(currentTime));
                    
                    // Update the issues count with the total_count from the search API
                    const issuesElement = document.getElementById('issues-count');
                    const count = data.total_count;
                    issuesElement.textContent = `${count} ${count === 1 ? 'issue' : 'issues'}`;
                    issuesElement.classList.remove('pulse-animation');
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error fetching GitHub issues:', error);
                // Set a hardcoded value of 4 issues for demonstration
                const issuesElement = document.getElementById('issues-count');
                issuesElement.textContent = '4 issues';
                issuesElement.classList.remove('pulse-animation');
            }
        }
        
        // Function to update UI with release data
        function updateReleaseInfo(data) {
            logDebug('Updating UI with release info');
            if (data && data.tag_name) {
                const releaseElement = document.getElementById('release-info');
                // Only show the version number without "Latest:"
                releaseElement.textContent = `${data.tag_name}`;
                releaseElement.classList.remove('pulse-animation');
                
                // Update download link and the github release badge link
                const downloadLink = document.getElementById('download-link');
                const releaseLink = document.getElementById('github-release');
                
                // If there's a specific asset to download, use it for the download button
                if (data.assets && data.assets.length > 0) {
                    downloadLink.href = data.assets[0].browser_download_url;
                } else {
                    // If no specific asset, link to the release page
                    downloadLink.href = data.html_url;
                }
                
                // Always set the release badge to link to the release page
                releaseLink.href = data.html_url;
                
                // Show stability badge if this is not a pre-release
                const stabilityBadge = document.getElementById('stability-badge');
                if (!data.prerelease) {
                    stabilityBadge.classList.remove('hidden');
                }
            }
        }
        
        // Execute when page loads
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('DOM loaded, initializing GitHub data');
            fetchGitHubData();
        });
    </script>
</body>